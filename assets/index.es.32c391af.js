import{P as k,o as j,V as F,b as _,h as G,e as O,k as K}from"./index.a6f92b97.js";import"./index.27ec1541.js";import"./color.556e4bcb.js";var E=200,u=function(){};u.prototype.append=function(e){return e.length?(e=u.from(e),!this.length&&e||e.length<E&&this.leafAppend(e)||this.length<E&&e.leafPrepend(this)||this.appendInner(e)):this};u.prototype.prepend=function(e){return e.length?u.from(e).append(this):this};u.prototype.appendInner=function(e){return new S(this,e)};u.prototype.slice=function(e,t){return e===void 0&&(e=0),t===void 0&&(t=this.length),e>=t?u.empty:this.sliceInner(Math.max(0,e),Math.min(this.length,t))};u.prototype.get=function(e){if(!(e<0||e>=this.length))return this.getInner(e)};u.prototype.forEach=function(e,t,n){t===void 0&&(t=0),n===void 0&&(n=this.length),t<=n?this.forEachInner(e,t,n,0):this.forEachInvertedInner(e,t,n,0)};u.prototype.map=function(e,t,n){t===void 0&&(t=0),n===void 0&&(n=this.length);var i=[];return this.forEach(function(r,p){return i.push(e(r,p))},t,n),i};u.from=function(e){return e instanceof u?e:e&&e.length?new D(e):u.empty};var D=function(s){function e(n){s.call(this),this.values=n}s&&(e.__proto__=s),e.prototype=Object.create(s&&s.prototype),e.prototype.constructor=e;var t={length:{configurable:!0},depth:{configurable:!0}};return e.prototype.flatten=function(){return this.values},e.prototype.sliceInner=function(i,r){return i==0&&r==this.length?this:new e(this.values.slice(i,r))},e.prototype.getInner=function(i){return this.values[i]},e.prototype.forEachInner=function(i,r,p,l){for(var a=r;a<p;a++)if(i(this.values[a],l+a)===!1)return!1},e.prototype.forEachInvertedInner=function(i,r,p,l){for(var a=r-1;a>=p;a--)if(i(this.values[a],l+a)===!1)return!1},e.prototype.leafAppend=function(i){if(this.length+i.length<=E)return new e(this.values.concat(i.flatten()))},e.prototype.leafPrepend=function(i){if(this.length+i.length<=E)return new e(i.flatten().concat(this.values))},t.length.get=function(){return this.values.length},t.depth.get=function(){return 0},Object.defineProperties(e.prototype,t),e}(u);u.empty=new D([]);var S=function(s){function e(t,n){s.call(this),this.left=t,this.right=n,this.length=t.length+n.length,this.depth=Math.max(t.depth,n.depth)+1}return s&&(e.__proto__=s),e.prototype=Object.create(s&&s.prototype),e.prototype.constructor=e,e.prototype.flatten=function(){return this.left.flatten().concat(this.right.flatten())},e.prototype.getInner=function(n){return n<this.left.length?this.left.get(n):this.right.get(n-this.left.length)},e.prototype.forEachInner=function(n,i,r,p){var l=this.left.length;if(i<l&&this.left.forEachInner(n,i,Math.min(r,l),p)===!1||r>l&&this.right.forEachInner(n,Math.max(i-l,0),Math.min(this.length,r)-l,p+l)===!1)return!1},e.prototype.forEachInvertedInner=function(n,i,r,p){var l=this.left.length;if(i>l&&this.right.forEachInvertedInner(n,i-l,Math.max(r,l)-l,p+l)===!1||r<l&&this.left.forEachInvertedInner(n,Math.min(i,l),r,p)===!1)return!1},e.prototype.sliceInner=function(n,i){if(n==0&&i==this.length)return this;var r=this.left.length;return i<=r?this.left.slice(n,i):n>=r?this.right.slice(n-r,i-r):this.left.slice(n,r).append(this.right.slice(0,i-r))},e.prototype.leafAppend=function(n){var i=this.right.leafAppend(n);if(i)return new e(this.left,i)},e.prototype.leafPrepend=function(n){var i=this.left.leafPrepend(n);if(i)return new e(i,this.right)},e.prototype.appendInner=function(n){return this.left.depth>=Math.max(this.right.depth,n.depth)+1?new e(this.left,new e(this.right,n)):new e(this,n)},e}(u);const U=500;class m{constructor(e,t){this.items=e,this.eventCount=t}popEvent(e,t){if(this.eventCount==0)return null;let n=this.items.length;for(;;n--)if(this.items.get(n-1).selection){--n;break}let i,r;t&&(i=this.remapping(n,this.items.length),r=i.maps.length);let p=e.tr,l,a,h=[],c=[];return this.items.forEach((o,f)=>{if(!o.step){i||(i=this.remapping(n,f+1),r=i.maps.length),r--,c.push(o);return}if(i){c.push(new g(o.map));let d=o.step.map(i.slice(r)),w;d&&p.maybeStep(d).doc&&(w=p.mapping.maps[p.mapping.maps.length-1],h.push(new g(w,void 0,void 0,h.length+c.length))),r--,w&&i.appendMap(w,r)}else p.maybeStep(o.step);if(o.selection)return l=i?o.selection.map(i.slice(r)):o.selection,a=new m(this.items.slice(0,n).append(c.reverse().concat(h)),this.eventCount-1),!1},this.items.length,0),{remaining:a,transform:p,selection:l}}addTransform(e,t,n,i){let r=[],p=this.eventCount,l=this.items,a=!i&&l.length?l.get(l.length-1):null;for(let c=0;c<e.steps.length;c++){let o=e.steps[c].invert(e.docs[c]),f=new g(e.mapping.maps[c],o,t),d;(d=a&&a.merge(f))&&(f=d,c?r.pop():l=l.slice(0,l.length-1)),r.push(f),t&&(p++,t=void 0),i||(a=f)}let h=p-n.depth;return h>z&&(l=V(l,h),p-=h),new m(l.append(r),p)}remapping(e,t){let n=new F;return this.items.forEach((i,r)=>{let p=i.mirrorOffset!=null&&r-i.mirrorOffset>=e?n.maps.length-i.mirrorOffset:void 0;n.appendMap(i.map,p)},e,t),n}addMaps(e){return this.eventCount==0?this:new m(this.items.append(e.map(t=>new g(t))),this.eventCount)}rebased(e,t){if(!this.eventCount)return this;let n=[],i=Math.max(0,this.items.length-t),r=e.mapping,p=e.steps.length,l=this.eventCount;this.items.forEach(f=>{f.selection&&l--},i);let a=t;this.items.forEach(f=>{let d=r.getMirror(--a);if(d==null)return;p=Math.min(p,d);let w=r.maps[d];if(f.step){let L=e.steps[d].invert(e.docs[d]),b=f.selection&&f.selection.map(r.slice(a+1,d));b&&l++,n.push(new g(w,L,b))}else n.push(new g(w))},i);let h=[];for(let f=t;f<p;f++)h.push(new g(r.maps[f]));let c=this.items.slice(0,i).append(h).append(n),o=new m(c,l);return o.emptyItemCount()>U&&(o=o.compress(this.items.length-n.length)),o}emptyItemCount(){let e=0;return this.items.forEach(t=>{t.step||e++}),e}compress(e=this.items.length){let t=this.remapping(0,e),n=t.maps.length,i=[],r=0;return this.items.forEach((p,l)=>{if(l>=e)i.push(p),p.selection&&r++;else if(p.step){let a=p.step.map(t.slice(n)),h=a&&a.getMap();if(n--,h&&t.appendMap(h,n),a){let c=p.selection&&p.selection.map(t.slice(n));c&&r++;let o=new g(h.invert(),a,c),f,d=i.length-1;(f=i.length&&i[d].merge(o))?i[d]=f:i.push(o)}}else p.map&&n--},this.items.length,0),new m(u.from(i.reverse()),r)}}m.empty=new m(u.empty,0);function V(s,e){let t;return s.forEach((n,i)=>{if(n.selection&&e--==0)return t=i,!1}),s.slice(t)}class g{constructor(e,t,n,i){this.map=e,this.step=t,this.selection=n,this.mirrorOffset=i}merge(e){if(this.step&&e.step&&!e.selection){let t=e.step.merge(this.step);if(t)return new g(t.getMap().invert(),t,this.selection)}}}class v{constructor(e,t,n,i,r){this.done=e,this.undone=t,this.prevRanges=n,this.prevTime=i,this.prevComposition=r}}const z=20;function R(s,e,t,n){let i=t.getMeta(I),r;if(i)return i.historyState;t.getMeta(Z)&&(s=new v(s.done,s.undone,null,0,-1));let p=t.getMeta("appendedTransaction");if(t.steps.length==0)return s;if(p&&p.getMeta(I))return p.getMeta(I).redo?new v(s.done.addTransform(t,void 0,n,y(e)),s.undone,A(t.mapping.maps[t.steps.length-1]),s.prevTime,s.prevComposition):new v(s.done,s.undone.addTransform(t,void 0,n,y(e)),null,s.prevTime,s.prevComposition);if(t.getMeta("addToHistory")!==!1&&!(p&&p.getMeta("addToHistory")===!1)){let l=t.getMeta("composition"),a=s.prevTime==0||!p&&s.prevComposition!=l&&(s.prevTime<(t.time||0)-n.newGroupDelay||!W(t,s.prevRanges)),h=p?C(s.prevRanges,t.mapping):A(t.mapping.maps[t.steps.length-1]);return new v(s.done.addTransform(t,a?e.selection.getBookmark():void 0,n,y(e)),m.empty,h,t.time,l==null?s.prevComposition:l)}else return(r=t.getMeta("rebased"))?new v(s.done.rebased(t,r),s.undone.rebased(t,r),C(s.prevRanges,t.mapping),s.prevTime,s.prevComposition):new v(s.done.addMaps(t.mapping.maps),s.undone.addMaps(t.mapping.maps),C(s.prevRanges,t.mapping),s.prevTime,s.prevComposition)}function W(s,e){if(!e)return!1;if(!s.docChanged)return!0;let t=!1;return s.mapping.maps[0].forEach((n,i)=>{for(let r=0;r<e.length;r+=2)n<=e[r+1]&&i>=e[r]&&(t=!0)}),t}function A(s){let e=[];return s.forEach((t,n,i,r)=>e.push(i,r)),e}function C(s,e){if(!s)return null;let t=[];for(let n=0;n<s.length;n+=2){let i=e.map(s[n],1),r=e.map(s[n+1],-1);i<=r&&t.push(i,r)}return t}function H(s,e,t,n){let i=y(e),r=I.get(e).spec.config,p=(n?s.undone:s.done).popEvent(e,i);if(!p)return;let l=p.selection.resolve(p.transform.doc),a=(n?s.done:s.undone).addTransform(p.transform,e.selection.getBookmark(),r,i),h=new v(n?a:p.remaining,n?p.remaining:a,null,0,-1);t(p.transform.setSelection(l).setMeta(I,{redo:n,historyState:h}).scrollIntoView())}let P=!1,x=null;function y(s){let e=s.plugins;if(x!=e){P=!1,x=e;for(let t=0;t<e.length;t++)if(e[t].spec.historyPreserveItems){P=!0;break}}return P}const I=new k("history"),Z=new k("closeHistory");function $(s={}){return s={depth:s.depth||100,newGroupDelay:s.newGroupDelay||500},new j({key:I,state:{init(){return new v(m.empty,m.empty,null,0,-1)},apply(e,t,n){return R(t,n,e,s)}},config:s,props:{handleDOMEvents:{beforeinput(e,t){let n=t.inputType,i=n=="historyUndo"?T:n=="historyRedo"?M:null;return i?(t.preventDefault(),i(e.state,e.dispatch)):!1}}}})}const T=(s,e)=>{let t=I.getState(s);return!t||t.done.eventCount==0?!1:(e&&H(t,s,e,!1),!0)},M=(s,e)=>{let t=I.getState(s);return!t||t.undone.eventCount==0?!1:(e&&H(t,s,e,!0),!0)},J=_(),N=_(),B=G(()=>({commands:()=>[O(J,()=>T),O(N,()=>M)],prosePlugins:()=>[$(),K({"Mod-z":T,"Mod-y":M,"Shift-Mod-z":M})]}))();export{N as Redo,J as Undo,B as history};
